<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>é£²é£Ÿåº—ä¸€è¦§</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <link href="/css/popup.css" rel="stylesheet">
  <link href="/css/thread-list.css" rel="stylesheet">
</head>
<body>


  <div id="app">
    <div id="app0">
      <th:block th:insert="common/header"></th:block>
    </div>
    <div class="thread-area">
    <h1  class="community-name" th:text="${name} + 'ã¸ã‚ˆã†ã“ãï¼'"></h1>
    <!-- <form action="/thread-add" method="get">
      <button type="submit" th:text="ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ–°è¦ä½œæˆ" @click="openPopup"></button>
      <input type="hidden" name="communityId" th:value="1">
    </form> -->



    <div v-if="isThreadAddPopup" class="popup-overlay" @click.self="closePopup('ThreadAdd')">
      <div class="popup">
        <h1>ã‚¹ãƒ¬ãƒƒãƒ‰æ–°è¦ä½œæˆ</h1>
        <p>ã‚¹ãƒ¬ãƒƒãƒ‰å(åº—å)ï¼š<input type="text" v-model="addThreadTitle"> <!-- String threadName;ã¨å¯¾å¿œã•ã›ã‚‹ --></p>
        <p>ãƒ•ãƒªã‚¬ãƒŠï¼š<input type="text"v-model="addThreadFurigana"></p>
        <p>ãŠåº—ã®ä½æ‰€ï¼š<input type="text"v-model="addThreadAddress"></p>
        <p>å–¶æ¥­æ™‚é–“ï¼š<input type="text"v-model="addThreadSalesTime"></p>
        <p>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š
          <select v-model="addThreadGenre">
            <option value="å’Œé£Ÿ" selected>å’Œé£Ÿ</option>
            <option value="ä¸­è¯">ä¸­è¯</option>
            <option value="ã‚¤ã‚¿ãƒªã‚¢ãƒ³">ã‚¤ã‚¿ãƒªã‚¢ãƒ³</option>
          </select>
        </p>
        <p>ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼š<input type="text" v-model="addThreadHashtags"></p>
        <button @click.self="addThread">ä½œæˆ</button>
        <button @click.self="closePopup('ThreadAdd')">é–‰ã˜ã‚‹</button>
      </div>
    </div>


    <div class ="sorting">
      <label><input type="radio" name="sortSelect" @click="sortItems('id')"></button>æŠ•ç¨¿ã®æ–°ã—ã„é †ã«ã™ã‚‹</label>
      <label><input type="radio" name="sortSelect" @click="sortItems('good_count')"></button>ã„ã„ã­ã®å¤šã„é †ã«ã™ã‚‹</label>
    </div>

      <button class="thread-create-button" type="button" @click="openPopup('ThreadAdd')" >ã‚¹ãƒ¬ãƒƒãƒ‰ã®æ–°è¦ä½œæˆ</button>
      <br>

    <div class="restaurant" v-for="thread in threads">
      <img src="restaurant-a.jpg" alt="é£²é£Ÿåº—A" class="restaurant-img">
      <div>
        <a href="#" class="restaurant-name"><h3>{{thread.title}}</h3></a>
        <div class="genre">ã‚¸ãƒ£ãƒ³ãƒ«ï¼š{{thread.genre}}</div>
        <div class="address">ä½æ‰€ï¼š{{thread.address}}</div>
        <div class="likes">
          <button @click="goodDeal(thread.id)">ã„ã„ã­ğŸ‘</button>
          <span>{{thread.good_count}}</span>
        </div>
        <div class="opening-hours">å–¶æ¥­æ™‚é–“ï¼š{{thread.sales_time}}</div>
        <div class="hashtags">
          <ul class="thread-list-ul" v-for="hashtag in thread.hashTagList">
            <li>
                <a href="#"> {{hashtag.tag_name}}</a>
            </li>
          </ul>
        </div>
      </div>
      <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰use_idã‚’ã‚‚ã£ã¦ãã¦ã€ã“ã“ã§åˆ¤åˆ¥ã€‚ -->
      <div class="delete-update">
        <button class="update-button" type="button" @click="openUpdateThread(thread.id)">æƒ…å ±ç·¨é›†</button>
        <button class="delete-button" type="button" v-if="thread.user_id == 1" @click="deleteThread(thread.id)">å‰Šé™¤</button>
      </div>
    </div>

    <div v-if="isThreadUpdatePopup" class="popup-overlay" @click.self="closePopup('ThreadUpdate')">
      <div class="popup">
        <h1>ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ç·¨é›†</h1>
        <p>ã‚¹ãƒ¬ãƒƒãƒ‰å(åº—å)ï¼š<input type="text" v-model="updateThreadTitle"> <!-- String threadName;ã¨å¯¾å¿œã•ã›ã‚‹ --></p>
        <p>ãƒ•ãƒªã‚¬ãƒŠï¼š<input type="text"v-model="updateThreadFurigana"></p>
        <p>ãŠåº—ã®ä½æ‰€ï¼š<input type="text"v-model="updateThreadAddress"></p>
        <p>å–¶æ¥­æ™‚é–“ï¼š<input type="text"v-model="updateThreadSalesTime"></p>
        <p>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š
          <select v-model="updateThreadGenre">
            <option value="å’Œé£Ÿ" selected>å’Œé£Ÿ</option>
            <option value="ä¸­è¯">ä¸­è¯</option>
            <option value="ã‚¤ã‚¿ãƒªã‚¢ãƒ³">ã‚¤ã‚¿ãƒªã‚¢ãƒ³</option>
          </select>
        </p>
        <p>ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼š<input type="text" v-model="updateThreadHashtags"></p>
        <button @click.self="updateThread">æ›´æ–°</button>
        <button @click.self="closePopup('ThreadUpdate')">é–‰ã˜ã‚‹</button>
      </div>
    </div>


</div>



  </div>
  <!-- <script src="/js/base.js"></script> -->
  <script>
    const { createApp } = Vue;

    createApp({
      data(){
        return{
          threads :[],
          showMenu: false,
          sessionInfo : [],
          sortKey: 'id',
          sortOrder: 'asc',

          //ã‚¹ãƒ¬ãƒƒãƒ‰æ–°è¦ä½œæˆç”¨
          isThreadAddPopup:false,
          addThreadTitle:'',
          addThreadFurigana:'',
          addThreadAddress:'',
          addThreadSalesTime:'',
          addThreadGenre:'å’Œé£Ÿ',
          addThreadHashtags:'',

          //ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ç·¨é›†ç”¨
          isThreadUpdatePopup:false,
          updateThreadId:'',
          updateThreadTitle:'',
          updateThreadFurigana:'',
          updateThreadAddress:'',
          updateThreadSalesTime:'',
          updateThreadGenre:'',
          updateThreadHashtags:'',

        }


      },


      methods:{
        getSessionInfo(){
          axios.get('/getSessionInfo')
          .then(res =>{
            this.sessionInfo =res.data;
            console.log(this.sessionInfo);
            console.log(res.data);
          });

        },
        // ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ã®å–å¾—
        getThreads(){
          axios.get('/getThreads')
          .then(res =>{
            this.threads =res.data;
            console.log(this.threads);
          });
        },

        //commonjsã®ã‚„ã¤ã€‚
        toggleMenu() {
          this.showMenu = !this.showMenu;
        },
        //ã„ã„ã­ãƒœã‚¿ãƒ³æŠ¼ã•ã‚ŒãŸæ™‚ã®æŒ™å‹•
        goodDeal(id){
          //è¨€ã„å€¤ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®åˆ¶å¾¡ã¯javaã§è¡Œã£ã¦ã„ã‚‹ã®ã§ã€
          //ãã®å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰getThreadsãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã™ã‚Œã°ãŠã£ã‘ãƒ¼ã€‚
          axios.get(`/goodDeal/${id}`)
          .then(res =>{
            this.getThreads();
          });
        },


        deleteThread(threadId){
          axios.delete(`/deleteThread/${threadId}`)
          .then(res =>{

            console.log(res.data);
            const result = res.data;
            if(result === true){
            this.getThreads();
            }else{
              alert('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒï¼‘ä»¶ä»¥ä¸Šå­˜åœ¨ã™ã‚‹ãŸã‚ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚')
            }

          });
        },

        //ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä¸¦ã³æ›¿ãˆonclickã§ä¸¦ã³æ›¿ãˆãŸã„ã‚­ãƒ¼ã®åå‰ã‚’å…¥ã‚Œã‚‹ã€‚
        sortItems(key) {

          const modifier = this.sortOrder === 'asc' ? 1 : -1;
          this.threads.sort((a, b) => {
            if (key === 'id') {
              return (b.id - a.id) * modifier;
            } else if (key === 'good_count') {
              return (b.good_count - a.good_count) * modifier;
            }
            return 0;
          });
        },

        openPopup(popupName) {
          this[`is${popupName}Popup`] = true;
        },
        closePopup(popupName) {
          // this.isPopup = false;
          this[`is${popupName}Popup`] = false;
        },
        addThread(){
          console.log('addThread');
          if(this.addThreadTitle ==''){
            alert('ãŠåº—ã®åå‰ã¯å¿…é ˆå…¥åŠ›ã§ã™')
          }else{
            const addInfo ={
                threadName:this.addThreadTitle,
                furigana:this.addThreadFurigana,
                address:this.addThreadAddress,
                salesTime:this.addThreadSalesTime,
                genre:this.addThreadGenre,
                hashtag:this.addThreadHashtags
            }
            if(this.addThreadHashtags.trim()==''){
              addInfo.hashtag=null
            }

            axios.post('/thread-add',addInfo)
            .then(res =>{
              this.getThreads();
              this.closePopup('ThreadAdd');
            });
          };

        },

        openUpdateThread(threadId){

          this.openPopup('ThreadUpdate');
          const targetThread = this.threads.find(thread =>thread.id === threadId);
          console.log(targetThread);
          this.updateThreadId =threadId;
          this.updateThreadTitle=targetThread.title;
          this.updateThreadFurigana=targetThread.furigana;
          this.updateThreadAddress = targetThread.address;
          this.updateThreadSalesTime = targetThread.sales_time;
          this.updateThreadGenre = targetThread.genre;
          this.updateThreadHashtags = targetThread.hashtags;


        },
        updateThread(){
          if(this.updateThreadTitle ==''){
            alert('ãŠåº—ã®åå‰ã¯å¿…é ˆå…¥åŠ›ã§ã™')
          }else{
            const updataInfo ={
                threadName:this.updateThreadTitle,
                furigana:this.updateThreadFurigana,
                address:this.updateThreadAddress,
                salesTime:this.updateThreadSalesTime,
                genre:this.updateThreadGenre,
                hashtag:this.updateThreadHashtags
            }

            axios.put(`/updateThread/${this.updateThreadId}`,updataInfo)
            .then(res =>{
              this.getThreads();
              this.closePopup('ThreadUpdate')
            });
          };

        },
      },

      created:function(){
        console.log("created");
        this.getThreads();
        this.getSessionInfo();
      }

    }).mount('#app')


    function uncheakRadiobutton(){
      console.log("æ¥ãŸã‚ˆ")
      let radioButtons = document.getElementsByName("sortSelect");
      for (var i = 0; i < radioButtons.length; i++) {
        radioButtons[i].checked = false;
      }
    }

  </script>



</body>
</html>
