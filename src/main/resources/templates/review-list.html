<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</title>
  <link href="/css/base.css" rel="stylesheet">
  <link href="/css/popup.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <link href="/css/review-list.css" rel="stylesheet">
  <style>
       .review-cell {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

  </style>
</head>

<body>

  <!--  <div id="app0">-->

  <!--    <th:block th:insert="common/header"></th:block>-->

  <!--  </div>-->

  <div id="app">
    <th:block th:insert="common/header"></th:block>

    <div class="review-area">
      <h2 style="font-size: 35px;">ã‚¹ãƒ¬ãƒƒãƒ‰åï¼š{{ updateThreadTitle }}</h2>

      <a :href="backThread()"
        style="text-decoration: none;background-color: rgb(196 255 235);width: 23%;font-size: 20px;background-color: rgb(184 249 255);border: 2px solid black;color: black;padding: 2px;text-decoration: none;">ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ã¸æˆ»ã‚‹</a>
      <p></p>
      <button type="button" @click="openUpdateThread()"
        style="font-size: 20px;background-color: #ffbf64;border: 2px solid black;color: black;padding: 2px;margin: 20px;">æƒ…å ±ç·¨é›†</button>

      <div v-if="isThreadUpdatePopup" class="popup-overlay" @click.self="closeUpdateThread()">
        <div class="popup">
          <h1>ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ç·¨é›†</h1>
          <p>ã‚¹ãƒ¬ãƒƒãƒ‰å(åº—å)ï¼š<input type="text" v-model="updateThreadTitle"> <!-- String threadName;ã¨å¯¾å¿œã•ã›ã‚‹ --></p>
          <!-- <p>ãƒ•ãƒªã‚¬ãƒŠï¼š<input type="text" v-model="updateThreadFurigana"></p> -->

          <p>ãŠåº—ã®ä½æ‰€ï¼š<input type="text" v-model="updateThreadAddress"></p>
          <p>å–¶æ¥­æ™‚é–“ï¼š<input type="text" v-model="updateThreadSalesTime"></p>
          <p>ã‚¸ãƒ£ãƒ³ãƒ«ï¼š
            <select v-model="updateThreadGenre">
              <option value="è©²å½“ãªã—" selected>è©²å½“ãªã—</option>
              <option value="å’Œé£Ÿ">å’Œé£Ÿ</option>
              <option value="ä¸­è¯">ä¸­è¯</option>
              <option value="ã‚¤ã‚¿ãƒªã‚¢ãƒ³">ã‚¤ã‚¿ãƒªã‚¢ãƒ³</option>
              <option value="æ´‹é£Ÿ">æ´‹é£Ÿ</option>
              <option value="ã‚«ãƒ•ã‚§">ã‚«ãƒ•ã‚§</option>
              <option value="å±…é…’å±‹">å±…é…’å±‹</option>
              <option value="ãƒ©ãƒ¼ãƒ¡ãƒ³">ãƒ©ãƒ¼ãƒ¡ãƒ³</option>
              <option value="ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰">ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰</option>
              <option value="ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯æ–™ç†">ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯æ–™ç†</option>
            </select>
          </p>
          <p>ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼š<input type="text" v-model="updateThreadHashtags"></p>
          <p>å†™çœŸã®è¿½åŠ ï¼š<input type="file" ref="fileInputThread" /></p>
          <div v-if="imageThread != ''">
            <p>æ›´æ–°å‰ã®ç”»åƒ</p>
            <div style="display: flex; justify-content: center;">
              <img :src="'data:image/png;base64,' + imageThread" style="width: 50px; height: auto;">
            </div>
          </div>

          <button @click.self="updateThread">æ›´æ–°</button>
          <button @click.self="closeUpdateThread()">é–‰ã˜ã‚‹</button>
        </div>

      </div>

      <div class="sorting">
        <label><input type="radio" name="sortSelect" @click="sortItems('id')"></button>æŠ•ç¨¿ã®æ–°ã—ã„é †ã«ã™ã‚‹</label>
        <label><input type="radio" name="sortSelect" @click="sortItems('good_count')"></button>ã„ã„ã­ã®å¤šã„é †ã«ã™ã‚‹</label>
      </div>

      <hr>

      <div class="review-all">
        <span class="red">{{ addError }}</span>
        <p class="font-size">
          <input style="width: 50%;height: 25px;" type="text" v-model="reviewTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
        </p>
        <p class="font-size">
          <textarea style="width: 80%;" cols="30" rows="10" v-model="content" placeholder="æœ¬æ–‡ï¼ˆå¿…é ˆï¼‰"></textarea>
        </p>
        <p class="font-size">
          è¿½åŠ ã®ç”»åƒï¼š
          <input style="font-size: 16px;" type="file" ref="fileInput" multiple />
        </p>

        <button class="button" type="button" @click="addReview">æŠ•ç¨¿</button>
        <button @click="addTestData">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿</button>
      </div>

      <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ -->
      <div class="review-all" v-for="review in reviews">

        <div class="review">

          <p><a :href="getUserReviewLink(review.userId)">{{ review.userName }}ã•ã‚“</a></p>
          <h3>{{review.title}}</h3>
          <p>æŠ•ç¨¿æ—¥ï¼š{{ review.createDate }}</p>

          <div class="image-review-container">
            <p class="review-cell" style="width: 100%; margin-right: 20px;">{{review.review}}</p>
            <div v-for="(image, index) in review.reviewImages">
              <div v-if="index === 0">
                <img :src="'data:image/png;base64,' + image.imagePath" style="width: 100px; height: auto;">
              </div>
            </div>
          </div>

        </div>

        <hr>

        <div v-for="(reply, index) in review.reviewReplies">
          <div v-if="index === 0" class="reply">
            <p><a :href="getUserReviewLink(reply.userId)">{{ reply.userName }}ã•ã‚“</a></p>
            <p class="review-cell" style="width: 100%;">{{ reply.reply }}</p>
            <p>æŠ•ç¨¿æ—¥ï¼š{{ reply.createDate }}</p>
          </div>
        </div>

        <div v-if="isReplyView && reviewId == review.reviewId" style="margin-bottom: 20px;">
          <h3>è¿”ä¿¡</h3>
          <p>
            æœ¬æ–‡ï¼š
            <textarea cols="30" rows="10" v-model="replyContent"></textarea>
          </p>
          <button type="button" @click="closeReply">é–‰ã˜ã‚‹</button>
          <button type="button" @click="addReply(review.reviewId)">é€ä¿¡</button>
          <button @click="replyTestData">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿</button>
        </div>

        <button class="button" type="button" v-if="review.userId == userId || sessionInfo.role === 2"
          @click="showDeleteConfirmation(review.reviewId)">å‰Šé™¤</button>
        <button class="button" type="button" v-if="review.userId == userId" @click="showEditPopup(review)">ç·¨é›†</button>
        <button class="button" type="button" @click="openReply(review.reviewId)">è¿”ä¿¡</button>

        <!-- <form action="/review-detail" method="get" style="margin-top: 20px;">
        <input type="hidden" name="reviewId" :value="review.reviewId" />
        <input type="hidden" name="threadId" th:value="${threadId}" />
        <button type="submit">è©³ç´°ç”»é¢ã¸</button>
      </form> -->

        <a style="display: flex;flex-direction: column;margin: 10px;font-size: 18px;"
          :href="getReviewDetailLink(review.reviewId)">è©³ç´°ç”»é¢ã¸</a>
        <!-- ã„ã„ã­ãƒœã‚¿ãƒ³ -->
        <div>
          <button class="button" @click="goodDeal(review.reviewId)">ã„ã„ã­ğŸ‘</button>
          <span style="font-size: 20px;">{{ review.goodCount }}</span>
        </div>

        <div v-if="showDeletePopup" class="popup-overlay">
          <div class="popup">
            <h2>å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h2>
            <button type="button" @click="deleteReview(reviewToDelete)">OK</button>
            <button type="button" @click="cancelDelete">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>

      </div>

      <!-- ç·¨é›†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
      <div v-if="showPopup" class="popup-overlay">
        <div class="popup">
          <h2>ç·¨é›†</h2>
          <p>ã‚¿ã‚¤ãƒˆãƒ«ï¼š<input type="text" v-model="editingReview.title"></p>
          <p>æœ¬æ–‡ï¼š<textarea cols="30" rows="10" v-model="editingReview.content"></textarea></p>
          <p>å†™çœŸã®è¿½åŠ ï¼š<input type="file" ref="fileInput" multiple /></p>
          <div v-if="editingReview.imageReview != ''">
            <p>æ›´æ–°å‰ã®ç”»åƒ</p>
            <div style="display: flex; justify-content: center;">
              <img v-for="image in editingReview.imageReview" :src="'data:image/png;base64,' + image.imagePath"
                style="width: 50px; height: auto;">
            </div>
          </div>

          <button type="button" @click="closePopup">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="button" @click="updateReview">æ›´æ–°</button>
        </div>
      </div>

    </div>

  </div>

  <!--  <script src="/js/base.js"></script>-->

  <script>
    const { createApp } = Vue

    createApp({
      data() {
        return {
          communityId: '',
          communityUrl: '',
          reviewTitle: '',
          content: '',
          reviews: [],
          isReplyView: false,
          replies: [],
          replyContent: '',
          reviewId: '',
          showPopup: false,
          editingReview: {
            id: '',
            title: '',
            content: '',
            imageReview: [],
          },
          threadId: '',
          addError: '',
          sortKey: 'id',
          sortOrder: 'asc',

          //ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ç·¨é›†ç”¨
          isThreadUpdatePopup: false,
          updateThreadId: '',
          updateThreadTitle: '',
          updateThreadFurigana: '',
          updateThreadAddress: '',
          updateThreadSalesTime: '',
          updateThreadGenre: '',
          updateThreadHashtags: '',
          imageThread: '',
          thread: [],

          reviewToDelete: '',
          showDeletePopup: false,

          userId: '',

          community: [],

          showMenu: false,
          userImage: '',

          sessionInfo: [],

        }
      },
      methods: {
        //ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰Šé™¤å‡¦ç†
        showDeleteConfirmation(reviewId) {
          this.reviewToDelete = reviewId;
          this.showDeletePopup = true;
        },
        deleteReview(reviewId) {
          console.log("success", reviewId);
          axios
            .delete(`/api/delete/${reviewId}`)
            .then(res => {
              // å‰Šé™¤æˆåŠŸæ™‚ã®å‡¦ç†
              this.getReviews(`[[ ${threadId} ]]`);
              this.cancelDelete();
              console.log(res);
            })
            .catch(error => {
              // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å‡¦ç†
              console.error(error);
            });
        },

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿å‡¦ç†
        addReview() {

          console.log(this.reviewTitle, this.content);
          const formData = new FormData();
          formData.append("threadId", `[[ ${threadId} ]]`);
          formData.append("title", this.reviewTitle);
          formData.append("content", this.content);

          // è¤‡æ•°ã®ç”»åƒã‚’FormDataã«è¿½åŠ 
          for (let i = 0; i < this.$refs.fileInput.files.length; i++) {
            formData.append('images', this.$refs.fileInput.files[i]);
          }
          console.log("ã“ã“ã¾ã§");

          axios.post('/add-review', formData)
            .then(res => {
              // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ãŸå ´åˆã®å‡¦ç†
              this.getReviews(`[[ ${threadId} ]]`);
              this.reviewTitle = '';
              this.content = '';
              //console.log(res);
            })
            .catch(error => {
              // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†
              this.addError = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ­£ã—ã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
            });
        },
        getReviews(threadId) {
          // this.reviews = [];

          axios.get('/getReviews', {
            params: {
              threadId: threadId
            }
          })
            .then(res => {
              //console.log("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—ã—ã¾ã—ãŸï¼");
              this.reviews = res.data;
            }
            );
        },

        //ç·¨é›†ãƒ»æ›´æ–°
        showEditPopup(review) {
          this.showPopup = true;
          this.editingReview.id = review.reviewId;
          this.editingReview.title = review.title;
          this.editingReview.content = review.review;
          this.editingReview.imageReview = review.reviewImages;
        },
        updateReview() {
          const formData = new FormData();
          // è¤‡æ•°ã®ç”»åƒã‚’FormDataã«è¿½åŠ 
          for (let i = 0; i < this.$refs.fileInput.files.length; i++) {
            formData.append('images', this.$refs.fileInput.files[i]);
          }

          formData.append('id', this.editingReview.id);
          formData.append('title', this.editingReview.title);
          formData.append('content', this.editingReview.content);

          if (this.editingReview.content == '') {
            alert('æœ¬æ–‡ãŒæœªå…¥åŠ›ã§ã™ã€‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          } else {

            // const updatedReview = {
            //   id: this.editingReview.id,
            //   title: this.editingReview.title,
            //   content: this.editingReview.content
            // };

            //formData.append('updatedReview', updatedReview);

            axios.put('/review-update', formData)
              .then(res => {
                this.getReviews(`[[ ${threadId} ]]`);
                this.closePopup();
                //console.log(updatedReview)
                console.log(res);

              });
          }

        },
        //è¿”ä¿¡ç”»é¢è¡¨ç¤º
        openReply(reviewId) {
          this.isReplyView = true;
          this.reviewId = reviewId;
        },
        //è¿”ä¿¡ç”»é¢éè¡¨ç¤º
        closeReply() {
          this.isReplyView = false;
        },
        //è¿”ä¿¡é€ä¿¡
        addReply(reviewId) {
          const formData = new FormData();
          formData.append("id", reviewId);
          formData.append("content", this.replyContent);

          if (this.replyContent == '') {
            alert('æœ¬æ–‡ãŒæœªå…¥åŠ›ã§ã™ã€‚å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          } else {

            axios.post('/add-reply', formData)
              .then(res => {
                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ãŸå ´åˆã®å‡¦ç†
                this.isReplyView = false;
                this.replyContent = '';
                this.getReviews(`[[ ${threadId} ]]`);
                console.log(res);
              })
              .catch(error => {
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã®å‡¦ç†
              });
          }
        },
        closePopup() {
          this.showPopup = false;
          this.editingReview.id = '';
          this.editingReview.title = '';
          this.editingReview.content = '';
        },
        cancelDelete() {
          this.reviewToDelete = null;
          this.showDeletePopup = false;
        },
        //ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ã«é·ç§»
        getUserReviewLink(userId) {
          return `/kuchannel/user-review/[[${community.id}]]/${userId}`;
        },
        //ã„ã„ã­ãƒœã‚¿ãƒ³æŠ¼ã•ã‚ŒãŸæ™‚ã®æŒ™å‹•
        goodDeal(reviewId) {
          //ã„ã„ã­ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®åˆ¶å¾¡ã¯javaã§è¡Œã£ã¦ã„ã‚‹
          axios.get(`/goodDeal/review/${reviewId}`)
            .then(res => {
              this.getReviews(`[[ ${threadId} ]]`);
            });
        },
        //ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä¸¦ã³æ›¿ãˆonclickã§ä¸¦ã³æ›¿ãˆãŸã„ã‚­ãƒ¼ã®åå‰ã‚’å…¥ã‚Œã‚‹ã€‚
        sortItems(key) {

          const modifier = this.sortOrder === 'asc' ? 1 : -1;
          this.reviews.sort((a, b) => {
            if (key === 'id') {
              return (b.reviewId - a.reviewId) * modifier;
            } else if (key === 'good_count') {
              return (b.goodCount - a.goodCount) * modifier;
            }
            return 0;
          });

        },

        //ã‚¹ãƒ¬ãƒƒãƒ‰ç·¨é›†ç”»é¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
        openUpdateThread() {
          this.isThreadUpdatePopup = true;

        },
        //ã‚¹ãƒ¬ãƒƒãƒ‰ç·¨é›†ç”»é¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        closeUpdateThread() {
          this.isThreadUpdatePopup = false;
        },

        //ã‚¹ãƒ¬ãƒƒãƒ‰ç·¨é›†
        updateThread() {
          if (this.updateThreadTitle == '') {
            alert('ãŠåº—ã®åå‰ã¯å¿…é ˆå…¥åŠ›ã§ã™')
          } else {
            const formData = new FormData();
            formData.append("threadName", this.updateThreadTitle);
            formData.append("furigana", this.updateThreadFurigana);
            formData.append("address", this.updateThreadAddress);
            formData.append("salesTime", this.updateThreadSalesTime);
            formData.append("genre", this.updateThreadGenre);

            if (this.updateThreadHashtags == '') {
              formData.append("hashtag", null);
            } else {
              const splited = this.updateThreadHashtags.split(/(ã€€| |ã€)/);
              const replaced = splited.map(item => item.replace(/[ï¼ƒ#]/g, ""));
              const filtered = replaced.filter(item => item !== " " && item !== "ã€");
              const trimed = filtered.map(item => item.trim());
              formData.append("hashtag", trimed);
            }
            formData.append("communityId", this.communityId);
            formData.append('image', this.$refs.fileInputThread.files[0]);
            axios.put(`/updateThread/${this.updateThreadId}`, formData)
              .then(res => {
                this.findThread(this.updateThreadId);
                this.closeUpdateThread();
              });

          };

        },

        //ä»»æ„ã®ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹
        findThread(threadId) {
          axios.get('/getThread', {
            params: {
              threadId: threadId
            }
          })
            .then(res => {
              this.thread = res.data;
              console.log(this.thread);
              //console.log(this.thread.title, this.thread.address, this.thread.genre, this.thread.hashtags);
              this.updateThreadTitle = this.thread.title;
              this.updateThreadFurigana = this.thread.furigana;
              this.updateThreadAddress = this.thread.address;
              this.updateThreadGenre = this.thread.genre;
              this.updateThreadHashtags = this.thread.hashtags;
              this.imageThread = this.thread.image_path;
            }
            );
        },

        getReviewDetailLink(reviewId) {
          const currentURL = window.location.href;
          console.log(currentURL);
          const returnURL = `${currentURL}/${reviewId}`
          console.log(returnURL);
          return returnURL;

        },


        //ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§ã¸æˆ»ã‚‹
        backThread() {

          return `${this.communityUrl}/${this.communityId}/threads`;

        },

        //ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£IDã‚’å–å¾—ã™ã‚‹
        getCommunityId() {
          axios.get('/getCommunityId', {
            params: {
              threadId: `[[ ${threadId} ]]`
            }
          })
            .then(res => {
              this.community = res.data;
            }
            );
        },

        toggleMenu() {
          this.showMenu = !this.showMenu;
        },

        getSessionInfo() {
          axios.get(`/getSessionInfo/${this.communityId}`)
            .then(res => {
              this.sessionInfo = res.data;
              console.log(this.sessionInfo);
              console.log(res.data);
            });

        },

        addTestData(){
          this.reviewTitle= 'é®®é­šã‚„ã¾ã¨ã¸è¡Œã£ã¦ãã¾ã—ãŸï¼ï¼';
          this.content= 'ä»Šæ—¥ã®ãŠæ˜¼ã«ã€åˆã‚ã¦é®®é­šã‚„ã¾ã¨ã¸è¡Œã£ã¦ãã¾ã—ãŸã€‚ã¨ã¦ã‚‚ç¾å‘³ã—ã‹ã£ãŸã§ã™ã€‚ã¾ãŸè¡ŒããŸã„ã§ã™ã€‚';
        },

        replyTestData(){
          this.replyContent = 'ç¾å‘³ã—ãã†ï¼ï¼ç§ã‚‚è¡Œã£ã¦ã¿ãŸã„ã¨æ€ã£ã¦ãŸã‚“ã ã‚ˆã­ã€‚ä»Šåº¦ä¸€ç·’ã«è¡Œãã¾ã›ã‚“ã‹ï¼Ÿ';
        },

      },
      created: function () {
        // this.threadId = `[[ ${threadId} ]]`;
        // this.getReviews(this.threadId);
        this.getReviews(`[[ ${threadId} ]]`);
        this.getCommunityId(`[[ ${threadId} ]]`);

        this.updateThreadId = `[[ ${thread.id} ]]`;
        this.updateThreadTitle = `[[ ${thread.title} ]]`;
        this.updateThreadAddress = `[[ ${thread.address} ]]`;
        this.updateThreadSalesTime = `[[ ${thread.sales_time} ]]`;
        this.updateThreadGenre = `[[ ${thread.genre} ]]`;
        this.updateThreadHashtags = `[[ ${thread.hashtags} ]]`;
        this.imageThread = `[[ ${thread.image_path} ]]`;
        this.communityId = `[[ ${community.id} ]]`
        this.communityUrl = `[[ ${community.url} ]]`
        console.log(this.imageThread);

        this.userId = `[[ ${userId} ]]`;

        this.userImage = `[[ ${image} ]]`;

        this.getSessionInfo();

      },
    }).mount('#app')

  </script>

</body>

</html>